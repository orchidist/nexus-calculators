<!DOCTYPE html>
<html>
    <head>
        <title>Salt/Freebase Converter</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script id="dataset" type="application/json">
            {
                "alkaloids": {
                    "n,n-DMT": { "molarMass": 188.27 },
                    "5-MeO-DMT": { "molarMass": 218.30 },
                    "mescaline": { "molarMass": 211.26 },
                    "harmine": { "molarMass": 212.25 },
                    "harmaline": { "molarMass": 214.29 },
                    "tetrahydroharman": { "molarMass": 186.25}
                },
                "acids": {
                    "freebase": {"molarMass": 0, "protons": 1 },
                    "acetate": { "molarMass": 60.05, "protons": 1 },
                    "ascorbate": { "molarMass": 176.12412, "protons": 1 },
                    "benzoate": { "molarMass": 122.12134, "protons": 1 },
                    "carbonate": { "molarMass": 62.02478, "protons": 1 },
                    "citrate": { "molarMass": 192.12, "protons": 3 },
                    "fumarate": { "molarMass": 116.0722, "protons": 2 },
                    "hydrochloride": { "molarMass": 36.46, "protons": 1 },
                    "malate": { "molarMass": 134.09, "protons": 2 },
                    "maleate": { "molarMass": 116.072, "protons": 2 },
                    "malonate": { "molarMass": 104.061, "protons": 2 },
                    "succinate": { "molarMass": 118.09, "protons": 2 },
                    "sulfate": { "molarMass": 98.08, "protons": 1 }, 
                    "tartarate": {"molarMass": 150.08, "protons": 2}
                }
            }
        </script>
        <script type="text/javascript">
            const waterMMass = 18.015;
            var dataset = JSON.parse($("#dataset").text());
            
            class Ion {
                constructor(name, data) {
                    this.name = name;
                    this.molarMass = data.molarMass;
                }

                toString() { 
                    return this.name; 
                }

                get charges() { return Array.from(Array(this.maxCharge).keys(), i=>i+1); }
            }

            class Acid extends Ion {
                constructor(name, data) {
                    super(name, data);
                    this.protons = data.protons || 1;
                }

                get maxCharge() { return this.protons; }
            }

            class Alkaloid extends Ion {
                constructor(name, data) {
                    super(name, data)
                    this.nitrogens = data.nitrogens || 1;
                }

                get maxCharge() { return this.nitrogens; }
            }

            class Salt {
                constructor(alkaloid, x, acid, y, hydration) {
                    this.alkaloid = alkaloid;
                    this.nAlkaloid = x;
                    this.acid = acid;
                    this.nAcid = y;
                    this.hydration = hydration
                }
                
                static convert(mass, SaltA, SaltB){
                    return SaltB.molesAlkaloidToMassSalt(SaltA.massToMolesAlkaloid(mass));
                }

                get molarMass() { 
                    var alkaloidMass = this.alkaloid.molarMass * this.nAlkaloid;
                    var acidMass = this.acid.molarMass * this.nAcid;
                    var hydrationMass = waterMMass * this.hydration;
                    return  alkaloidMass + acidMass + hydrationMass;
                }

                toString() {
                    var ratioString = (this.nAlkaloid == 1 && this.nAcid == 1) ? " " : ` ${this.nAlkaloid}:${this.nAcid} `;
                    var hydrationString = (this.hydration > 0) ? ` ${this.hydration}-hydrate` : "";
                    return `${this.alkaloid}${ratioString}${this.acid}${hydrationString}`;
                }

                massToMolesSalt(mass) { return mass / this.molarMass; }

                massToMolesAlkaloid(mass) { return this.massToMolesSalt(mass) * this.nAlkaloid; }

                massToMassAlkaloid(mass) { return this.massToMolesAlkaloid(mass) * this.alkaloid.molarMass; }

                molesSaltToMass(molesSalt) { return molesSalt * this.molarMass; }

                molesAlkaloidToMolesSalt(molesAlkaloid) { return molesAlkaloid / this.nAlkaloid; }

                molesAlkaloidToMass(molesAlkaloid) { return molesAlkaloid * this.alkaloid.molarMass; }

                molesAlkaloidToMassSalt(molesAlkaloid) { return this.molarMass * molesAlkaloid / this.nAlkaloid }

                calculateYieldPercent(rawMaterialMass, mass) {
                    return 100 * this.massToMassAlkaloid(mass) / rawMaterialMass;
                }

                isConvertibleTo(saltB) {
                    return this.alkaloid == saltB.alkaloid && (
                        this.nAlkaloid != saltB.nAlkaloid ||
                        this.acid != saltB.acid || 
                        this.nAcid != saltB.nAcid ||
                        this.hydration != saltB.hydration
                    );
                }
            }
        </script>

        <script type="text/javascript">
            function initializeIonOptions() {
                $.each(dataset["alkaloids"], function(name, data){
                    var option = $(new Option(name, name));
                    option.data("ion", new Alkaloid(name, data));
                    $("#alkaloid").append(option);
                });
                $.each(dataset["acids"], function(name, data){
                    var option = $(new Option(name, name));
                    option.data("ion", new Acid(name, data));
                    $("#acid").append(option);
                });

                $("#alkaloid").first().select();
                $("#acid").first().select();
            }

            function initializeRatios() {
                var acid = $("#acid :selected").data("ion");
                var $ratioSelector = $("#stoichiometry");

                $ratioSelector.hide();
                $ratioSelector.children().remove();

                $.each(acid.charges, function(i, charge){
                    var option = new Option(charge, charge);
                    $ratioSelector.append(option);
                })
                $ratioSelector.first().select();

                if (acid.maxCharge > 1) {
                    $ratioSelector.show();
                }
            }

            function initializeSaltOutputTable(){
                var $tableBody = $("#outputTable tbody");

                $("#alkaloid option").each(function(){
                    var alkaloid = $(this).data("ion");
                    $("#acid option").each(function(){
                        var acid = $(this).data("ion");
                        $.each(acid.charges, function(i, charge){
                            var salt = new Salt(alkaloid, charge, acid, 1, 0);
                            var $tableRow = $(`
                            <tr class="salt">
                                <td class="massOutput"></td>
                                <td>${salt}</td>
                                <td>
                                    <input class="hydration" type="number" value="0" min="0" />
                                </td>
                            </tr>
                            `);

                            $tableRow.data("salt", salt);
                            $tableBody.append($tableRow);
                        });
                    });
                });

                $tableBody.find("tr").hide();
            };

            function getSaltA() {
                var alkaloid = $("#alkaloid :selected").data("ion");
                var acid = $("#acid :selected").data("ion");
                var acidACharge = $("#stoichiometry :selected").val();
                var hydration = $("#hydration").val();

                return new Salt(alkaloid, acidACharge, acid, 1, hydration);
            }

            function calculateYield(){
                var salt = getSaltA();
                var rawMass = $("#rawMass").val();
                var productMass = $("#mass").val();
                
                var percentYield = salt.calculateYieldPercent(rawMass, productMass);

                $("#yieldData").html(`
                    <span class="bold">Yield:</span> ${percentYield.toPrecision(2)} % freebase ${salt.alkaloid}
                `);
            }

            function convertSalts() {
                var saltAMass = $("#mass").val();
                var saltA = getSaltA();
            
                $(".salt").hide();

                //Get all salts that can be converted from salt A
                var $targetSalts = $(".salt").filter(function(){
                    var saltB = $(this).data("salt");
                    return saltA.isConvertibleTo(saltB);
                });
                
                $targetSalts.each(function(){
                    var $saltRow = $(this);
                    var saltB = $saltRow.data("salt");
                    $saltRow.find(".massOutput").text(Salt.convert(saltAMass, saltA, saltB).toPrecision(4));
                });

                $targetSalts.show();
            }

            function recalculateSaltB() {
                var $hydrationInput = $(this);
                var $targetRow = $hydrationInput.parents(".salt");
                var salt = $targetRow.data("salt");
                
                salt.hydration = $hydrationInput.val();
                convertSalts();
            }

            $(document).ready(function(){
                initializeIonOptions();
                initializeRatios();
                initializeSaltOutputTable();
                calculateYield();
                convertSalts();

                $("#converterForm").change(function() {convertSalts();  calculateYield();});
                $('#converterForm').submit(false);

                // When changing the acid selection, repopulate the ratios selector
                $("#acid").change(initializeRatios());

                $(".hydration").change(recalculateSaltB);
            });
        </script>
        <style>
            label, .bold {font-weight: bold;}
            label[for="hydration"] {font-weight: unset;}
            .formDiv {padding: 10px; }
            #outputTable { padding-top: 30px; padding-left: 5px; }
            #outputTable th { text-align: left; }
        </style>
    </head>
    <body>
        <form id="converterForm">
            <div class="formDiv">
                <label for="alkaloid">Compound</label>
                <select id="alkaloid" name="alkaloid"></select>
                <select id="stoichiometry"></select>
                <select id="acid" name="acid"></select>
                <input id="hydration" type="number" value="0" min="0" />
                <label for="hydration">hydrate</label>
            </div>
            <div class="formDiv">
                <label for="rawMass">Raw material mass</label>
                <input id="rawMass" type="number" value="100.000" /> g
            </div>
            <div class="formDiv">
                <label for="mass">Product mass</label>
                <input id="mass" type="number" value="1.000" /> g
            </div>
            <div id="yieldData" class="formDiv"></div>
        </form>
        <div>
        <form id="saltConversions">
            <table id="outputTable">
                <thead>
                    <tr>
                        <th width="180px">Mass (<span id="unit">g</span>)</th>
                        <th>Compound</th>
                        <th class="targetHydration">Hydration</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </form>
        </div>
    </body>
</html>